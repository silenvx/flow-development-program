# 改善アクション

自律完遂度評価、改善点洗い出し、Issue判定、Issue作成。

## 5. 自律完遂度の評価

### 5.1 中断イベントの抽出

| 中断タイプ | 検出方法 | 例 |
|-----------|----------|-----|
| **フックブロック** | ログから抽出 | `decision: "block"` によるブロック |
| **AskUserQuestion使用** | 記憶から抽出 | 選択肢の提示、確認 |
| **ユーザー指示待ち** | 記憶から抽出 | 「〜しますか？」 |
| **エラー報告・相談** | 記憶から抽出 | 問題発見時の報告 |

**ログからの抽出コマンド**:

```bash
# フックブロック一覧
cat ".claude/logs/execution/hook-execution-$SESSION_ID.jsonl" | jq -r 'select(.decision == "block") | "\(.timestamp // "unknown") | \(.hook // "unknown") | \(.reason // "理由なし")"'
```

### 5.2 中断の適切性評価

| 判定 | 基準 | 例 |
|------|------|-----|
| **必要** | セキュリティ、破壊的操作、重大な選択肢 | 本番データ削除の確認 |
| **不要** | 自動化可能、ルール明確化で回避可能 | マージ確認（AGENTS.mdで自動マージ指示あり） |

### 5.3 自律完遂度スコア

```
必要な中断数 = 総中断数 - 不要な中断数

自律完遂度 =
  - 総中断数 > 0 の場合: 必要な中断数 / 総中断数 × 100%
  - 総中断数 = 0 の場合: 100%
```

- **100%**: 全ての中断が必要だった（理想）
- **80%以上**: 良好
- **80%未満**: 改善が必要（Issue作成必須）

### 5.4 不要な中断への対策

**不要な中断**が見つかった場合、以下のアクションを実行してください：

| 根本原因 | 対策 |
|----------|------|
| ルールの認識不足 | AGENTS.md/Skillsを再読してルールを確認 |
| ルールの不明確さ | ルール明確化のIssueを作成 |
| フック設計の問題 | フック改善のIssueを作成 |
| 自動化の欠如 | 自動化フック/スクリプトのIssueを作成 |

**Issue作成時のラベル**: `enhancement`, `developer-experience`

**出力形式**:

```markdown
### 対策

| 不要な中断 | 根本原因 | 対策 | Issue |
|-----------|----------|------|-------|
| マージ確認 | AGENTS.mdルールの認識不足 | ルール再確認（Issue不要） | - |
| worktree作成確認 | 自動化の欠如 | 自動worktree作成フック | #xxx |
```

### セクション5の観点チェック

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **自律完遂度** | 中断イベントを全て抽出し、適切性を評価したか | [ ] |

## 6. 改善点の洗い出し

### 反省点の対策

反省点は「ドキュメント化」または「仕組み化」する:

| 対策         | 優先度   | 例                     |
| ------------ | -------- | ---------------------- |
| 仕組み化     | **高**   | フック、CI、ツール     |
| ドキュメント化 | 低       | AGENTS.md追記          |

**重要**: ドキュメント追加だけでは問題は解決しない。仕組み化を優先。

### なぜなぜ分析（5 Whys）

問題発生時に根本原因を特定:

```text
問題: [発生した問題]

なぜ1: [直接的な原因]
なぜ2: [なぜ1の原因]
なぜ3: [なぜ2の原因]
なぜ4: [なぜ3の原因]
なぜ5: [根本原因]

対策: [根本原因への対策]
```

**ポイント**:

- 個人ではなくプロセス・仕組みに焦点
- 5回は目安、根本原因に到達したら終了
- 再発防止策に繋げる

### 教訓の記録方法

**重要**: 教訓や改善点を発見したら、`[lesson]` タグを使って明示的にマークしてください。

**タグ形式**:

```markdown
[lesson] 教訓の内容 → Issue #番号
```

| 条件 | 動作 |
|------|------|
| `[lesson]` タグあり、Issue参照なし | **ブロック**（Issue化必須） |
| キーワードのみ（タグなし） | 警告（ブロックしない） |
| `[lesson]` タグあり、Issue参照あり | 正常（通過） |

### 仕組み化の完成度チェック

「仕組み化」を謳うIssueをクローズした場合、以下を確認：

| チェック項目 | 確認内容 |
|-------------|----------|
| **ドキュメント** | AGENTS.md等にルールが追記されているか |
| **強制機構** | フック/CI/ツールで違反が自動的にブロックされるか（警告のみは不十分） |

**重要**: ドキュメント追加だけでは「仕組み化完了」とは言えない。強制機構がなければ再発防止にならない。

### AIレビュー依存パターンの検出（必須）

**重要**: 振り返り中に以下のパターンを使用していないか確認する。

| 禁止パターン | なぜ禁止か |
|-------------|-----------|
| 「レビューで検出可能」 | AIレビューを安全網として期待している |
| 「AIレビューが指摘してくれた」 | 自分で事前に気づくべきだった |
| 「Copilot/Codex/Geminiに任せる」 | 責任転嫁 |
| 「レビューで修正済み」のみで終了 | 根本原因の分析がない |

**発見時の対応**:

1. **なぜ自分で事前に気づけなかったか**を分析
2. 今後同様の問題を**自分で検出できる仕組み**をIssue化
3. 「AIレビューは存在しないもの」として対策を考える

**背景**: PR #2668でフック名の誤り（`main-sync-check.py` vs `main_sync_check.py`）をAIレビューが検出。振り返りで「レビューで検出可能だからIssue不要」と判断したが、これはAIレビュー依存であり不適切（Issue #2671）。

### ユーザーフィードバック対応の確認（必須）

**重要**: セッション中にユーザーが問題を指摘した場合、その対応を確認する。

| チェック項目 | 確認内容 |
|-------------|----------|
| **問題の認識** | ユーザーの指摘を正しく理解したか |
| **問題の修正** | 指摘された問題を修正したか |
| **仕組み化** | 類似問題を将来検出できる仕組みを作成したか |

**仕組み化の方法**:

1. `/add-perspective` で振り返り観点を追加
2. `.claude/hooks/` にフックを作成して検出機構を実装
3. `.github/workflows/` にCIチェックを追加
4. 仕組み化が不要な理由をIssueに記録

**禁止パターン**:

| パターン | なぜ禁止か |
|---------|-----------|
| 問題を修正して終了 | 同じ問題が再発する |
| 「今後気をつける」 | 仕組み化されていない |
| ドキュメント追記のみ | 強制力がない |

**背景**: Issue #2754 で導入。ユーザーが問題を指摘した場合、その問題の修正だけでなく、類似問題を将来検出できる仕組み化が必要。

### セクション6の観点チェック

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **根本原因** | なぜなぜ分析をしたか | [ ] |
| **見落とし** | 「他にないか？」を3回自問したか | [ ] |
| **安易な判断** | 「問題なし」と判断する前に十分検討したか | [ ] |
| **Issue化** | 発見した問題をIssue化したか | [ ] |
| **「対応済み」検証** | 仕組みの実行タイミングを確認し、有効か検証したか | [ ] |
| **振り返り自体の評価** | 形式的なチェックリスト消化になっていないか | [ ] |
| **AIレビュー依存** | 「レビューで検出可能」を理由にIssue省略していないか | [ ] |
| **ユーザーフィードバック対応** | 指摘された問題を仕組み化したか | [ ] |
| **不整合発見時の実態確認** | テストや既存コードの期待値を鵜呑みにせず、実態（ファイル名、過去のリファクタリング等）を確認したか | [ ] |
| **「後で対応」発言のIssue化** | セッション中に「別途対応」「後で」等と発言した問題がIssue化されているか | [ ] |
| **既存プロンプト/Skill確認** | 操作実行前に、関連するプロンプト/Skillの手順を確認したか | [ ] |
| **「やったこと」と「背景・目的」の整合性** | 報告した「やったこと」が当初の背景・目的と整合しているか（コマンド単位、sub-agent単位、セッション単位） | [ ] |
| **Issue作成後の自動着手確認** | Issue作成後に「次は何をしますか？」と確認を求めていないか。AGENTS.md原則「セッション内で作成したIssueは確認を求めずに即座に着手」を遵守しているか | [ ] |
| **バリデーション追加時の正常系確認** | 新しいチェック/バリデーションを追加する際、正常系フロー（プレースホルダー、特殊パターン等）を壊さないか事前確認したか | [ ] |
| **重複コードパターンの抽出** | 類似ロジックが複数箇所に存在する場合、再利用可能なモジュール/ライブラリに抽出したか | [ ] |
| **配列操作時のエッジケース確認** | .pop()や[index]アクセス前に配列長を検証しているか確認したか | [ ] |
| **教訓発見時の仕組み化確認** | 振り返りで教訓/ルール違反を発見した場合、/add-perspectiveやフック作成などの仕組み化アクションを同時に実行したか | [ ] |
| **移行・リファクタリング時のテスト優先確認** | コード移行やリファクタリング時に、テストを最優先で実装/移行したか。テスト削除後に新テスト追加を先送りしていないか | [ ] |
| **todoタスク自動継続確認** | todoリストにあるタスク完了後、「着手しますか？」等の確認を求めず次のpendingタスクに自動着手したか | [ ] |
| **問題報告時の初動確認** | ユーザーが問題を報告した際、ログ調査よりも先に「具体的に何が起きたか」をユーザーに質問したか | [ ] |
| **レビューコメント読み込み後のアクション継続** | レビューコメントを読み込んだ後、テキストのみで終わらず修正アクション（Edit、Bash等）を実行したか | [ ] |
| **コマンドエラー後の自律的継続** | コマンドがエラーで終了した後、ユーザー入力待ちにならず、別のアプローチを試みたか | [ ] |
| **レビュースレッドのResolve完遂確認** | AIレビュー（Copilot/Codex/greptile等）のスレッドに返信した後、Resolveまで実行したか。返信だけでは完了ではなく、Resolveして初めて対応完了となる | [ ] |
| **ブロック後のツール呼び出し継続確認** | ブロック後にテキストのみで停止せず、AskUserQuestion等のツール呼び出しを継続したか | [ ] |

## 7. Issue判定の記録（Issue #2677）

**目的**: Issue作成/不作成の判定を記録し、後から判定の妥当性を評価可能にする。

### 7.1 Issue作成する場合

`gh issue create` 実行時に**自動記録**される（手動対応不要）。

### 7.2 Issue作成しない場合（skip判定）

問題を検討したが、Issue作成しないと判断した場合は、**振り返り本文内に判定理由を明記**する。

**記載形式**:

```markdown
### Issue判定: skip

| 問題 | 理由 | 補足 |
|------|------|------|
| [問題の概要] | [理由] | [関連Issue等] |
```

**理由の例**:

| 理由 | 使用場面 |
|------|----------|
| `既存ルールでカバー` | AGENTS.md等に既存ルールがあり、追加アクション不要 |
| `重複` | 既存のオープンIssueと同じ問題（関連Issue番号を補足に記載） |
| `既に対応済み` | このセッション内で既に修正済み |

**注意**: 「軽微だから」という理由でのスキップは禁止。Section 9「severityに関わらず全てIssue化」ルール参照。

**重複の場合の例**:

```markdown
### Issue判定: skip

| 問題 | 理由 | 補足 |
|------|------|------|
| フックの競合状態 | 重複 | #1234 |
```

### 7.3 判定評価

**評価指標**（定期的に確認推奨）:

| 判定 | 評価方法 | 問題判定 |
|------|----------|----------|
| create | Issue状態確認 | NOT_PLANNED → 不適切（作成すべきでなかった） |
| skip | 類似Issue検索 | 後から類似Issue作成 → 見逃しの可能性 |

**確認コマンド**:

```bash
# NOT_PLANNEDでクローズされたIssueを確認（直近10件）
gh issue list --state closed --limit 50 --json number,title,stateReason,closedAt \
  --jq '[.[] | select(.stateReason == "NOT_PLANNED")] | sort_by(.closedAt) | reverse | .[0:10] | .[] | "#\(.number) \(.title)"'
```

## 8. セッション内Issue完遂チェック（必須）

**重要**: 振り返り完了前に、このセッションで作成したIssueが全て完遂されているか確認する。

### 8.1 セッション内で作成したIssueの確認

**手順**:
1. このセッションの会話履歴で `gh issue create` を検索
2. 作成したIssue番号をメモ
3. 各Issueの状態を確認

```bash
# 自分が作成したオープンIssueを一覧（直近作成順）
gh issue list --author @me --state open --json number,title,createdAt --jq 'sort_by(.createdAt) | reverse | .[] | "#\(.number) \(.title) (\(.createdAt | split("T")[0]))"'
```

**注意**: 上記コマンドは全オープンIssueを表示。このセッションで作成したものを手動で特定する。

### 8.2 未完遂Issueの対応

| 状態 | 対応 |
|------|------|
| オープン & 未着手 | **即座に実装を開始**（振り返りを中断） |
| オープン & 作業中（別worktree） | 競合確認後、継続または待機 |
| クローズ済み | 問題なし |

**AGENTS.mdルール**:
> セッション内で作成したIssueは**確認を求めずに即座に着手**し、同じセッション内で実装・マージまで完遂する

### 8.3 チェックリスト

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **セッション内Issue特定** | 会話履歴で `gh issue create` を検索し、作成したIssue番号を特定 | [ ] |
| **各Issueの状態確認** | `gh issue view <番号>` で状態を確認（OPEN/CLOSED） | [ ] |
| **未完遂Issueへの対応** | OPENのIssueがあれば、即座に実装を開始（振り返りを中断） | [ ] |

**背景**: Issue #3445 - PR #3442マージ後、セッション内で作成したIssue #3439の存在を忘れ、実装せずに「何をしますか？」と聞いてしまった。

---

## 9. Issue作成（必須）

**重要**: 改善点が見つかった場合、**severity に関わらず全てIssue化が必須**です。

発見した改善点について：
- 1つの問題につき1つのIssueを作成
- 再現手順と期待動作を含める
- 適切なラベルを付与
