# テスト

テスト必須、TDD、新機能ライフサイクルチェックリスト。

## テスト必須

- 新機能・バグ修正には対応テストを追加
- APIエンドポイント変更時は `worker/src/index.test.ts` にテスト追加
- エラーケース（400, 403, 404, 409等）も必ずテスト

## 条件分岐追加時のテストケース

**ルール**: 新しい条件分岐を追加したら、その条件のテストも追加する

| 変更内容 | 必要なテスト |
|----------|-------------|
| 除外条件を追加 | 除外が正しく機能することを確認するテスト |
| 新しい分岐を追加 | その分岐を通るテストケース |
| エラーハンドリング追加 | エラー時の動作を確認するテスト |

**例**: Issue #1835で`ast.Subscript`の`ctx`属性チェックを追加した際、Storeコンテキストが誤検知されないテストを追加すべきだった（Copilotに指摘されてから追加）

```python
# ❌ 条件分岐を追加したがテストなし
if isinstance(node.ctx, ast.Load):  # 新しい条件
    # ...処理...

# ✅ 条件分岐と対応するテストを追加
def test_ignores_subscript_store():
    """辞書への書き込み（Store）は誤検知しない"""
    source = 'event["tool_result"] = value'
    errors = check_tool_response_fallback(...)
    assert len(errors) == 0  # 書き込みは対象外
```

**チェックリスト**（コミット前）:
- [ ] 新しい条件分岐を追加したか？
- [ ] その条件を通る/通らないテストケースがあるか？
- [ ] 既存テストだけでなく、新しい動作をカバーするテストを追加したか？

## テスト実行

```bash
# 全テスト
pnpm test:ci

# Worker テスト
pnpm test:ci:worker
```

## テスト駆動開発（TDD）

**目的**: 同一ファイルへの再作業（短時間内の複数編集）を減らす。

### なぜTDDが必要か

| 問題 | 原因 | TDDによる解決 |
|------|------|--------------|
| 5分以内に同じファイルを5回編集 | テストなしで実装→失敗→修正の繰り返し | 先にテストを書き、1回で正しく実装 |
| CIで失敗してから修正 | ローカルテストせずにCIに依存 | ローカルでテストを通してからコミット |
| エッジケースの見落とし | 実装後にエッジケースを発見 | テストでエッジケースを事前に洗い出し |

### TDDの基本フロー

```bash
# 1. テストを書く（失敗する）
# 2. 実装する（テストが通る）
# 3. リファクタリング（テストが通ったまま）
```

### フック開発でのTDD例

```python
# tests/test_my_hook.py
def test_basic_case():
    """正常系: 期待通りの入力で期待通りの出力"""
    result = process_input({"command": "git status"})
    assert result["decision"] == "approve"

def test_edge_case_empty_command():
    """エッジケース: 空のコマンド"""
    result = process_input({"command": ""})
    assert result["decision"] == "approve"  # フェイルオープン

def test_error_case_invalid_json():
    """エラーケース: 不正なJSON"""
    # JSONエラー時もフェイルオープン
    ...
```

### 実装前に考慮すべきテストケース

| カテゴリ | 例 |
|----------|-----|
| **正常系** | 期待通りの入力 |
| **境界値** | 空文字、ゼロ、最大値 |
| **エッジケース** | 特殊文字、長い文字列、Unicode |
| **エラーケース** | 不正な入力、タイムアウト、外部コマンド失敗 |
| **並行性** | 複数プロセスからの同時アクセス |

### TDD実践のチェックリスト

- [ ] 実装前にテストファイルを作成
- [ ] 最低3つのテストケース（正常・境界・エラー）を書く
- [ ] テストが失敗することを確認
- [ ] 実装してテストが通ることを確認
- [ ] 追加のエッジケースを洗い出してテスト追加

## 新機能のライフサイクルチェックリスト

新しい機能（特にグローバル状態を持つもの）を実装する際は、以下を確認する。

### 背景

PR #1633でErrorContextManagerを実装した際、`flush_pending()`がセッション終了時に呼ばれないバグがCodex CLIレビューで発見された。原因は、実装時にセッション終了フローを確認しなかったため。

### ライフサイクルチェック

| フェーズ | 確認項目 | 例 |
|----------|----------|-----|
| **初期化** | どこで初期化されるか？ | セッション開始時、最初の呼び出し時 |
| **実行中** | いつ・どこで呼び出されるか？ | 各フック実行時、特定イベント時 |
| **終了** | 終了処理はどこで行われるか？ | session_metrics_collector.py |
| **異常終了** | エラー時のクリーンアップは？ | try/finally、シグナルハンドラ |

### 統合ポイントチェック

| チェック項目 | 確認方法 |
|--------------|----------|
| 既存フックとの統合 | `grep -r "session_id" .claude/hooks/` で関連フック特定 |
| セッション開始フック | SessionStart フックに初期化が必要か |
| セッション終了フック | `session_metrics_collector.py` に終了処理が必要か |
| グローバル状態の永続化 | 適切なタイミングでファイル書き込みされるか |

### 実装前チェックリスト

新機能を実装する**前**に確認:

- [ ] この機能はグローバル状態（シングルトン、モジュール変数）を持つか？
- [ ] 持つ場合、初期化タイミングは明確か？
- [ ] 持つ場合、終了時のflush/cleanup処理は実装されているか？
- [ ] セッション開始/終了フックへの統合が必要か確認したか？
- [ ] 異常終了時（SIGTERM、例外）でもデータが失われないか？

### 実装後チェックリスト

新機能を実装した**後**に確認:

- [ ] 正常終了時のテストを追加したか？
- [ ] 異常終了時のテストを追加したか？
- [ ] 複数セッション並行時のテストを追加したか？
- [ ] `session_metrics_collector.py`への統合が必要な場合、追加したか？

### 関連Issue

- Issue #1636: flush_pending未呼び出しバグ
- Issue #1641: このチェックリストの追加
