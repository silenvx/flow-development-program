# レビュー対応プロセス

レビューコメントの判断基準と対応フロー。

## 範囲内/範囲外の判断基準

**最重要原則: このPRで導入したバグは、このPRで修正する**

レビューで発見されたバグを別Issueにしてマージするのは間違い。バグ込みでマージすることになる。

### バグの発生源で判断

| バグの発生源 | 対応 | 理由 |
| ------------ | ---- | ---- |
| **このPRで書いたコード** | 同じPRで修正（必須） | バグ込みでマージしない |
| **既存コード（偶然発見）** | 別Issue作成 | PRスコープ外 |

**具体例**:
- ✅ このPRで追加した関数にバグ → 同じPRで修正
- ✅ このPRで追加した関数のテスト不足 → 同じPRでテスト追加
- ✅ このPRで追加した機能のエッジケース未対応 → 同じPRで対応
- ❌ 既存の認証処理にバグ発見 → 別Issue

**アンチパターン（実際に発生した問題: PR #1126）**:
```
1. PR #100 で新機能を実装
2. レビューで「このコードにバグがある」と指摘
3. 「範囲外」としてIssue #101 を作成  ← ❌ 間違い
4. PR #100 をバグ込みでマージ         ← ❌ 問題
5. Issue #101 は未解決のまま          ← ❌ 放置
```

正しいフロー:
```
1. PR #100 で新機能を実装
2. レビューで「このコードにバグがある」と指摘
3. 同じPR #100 でバグを修正           ← ✅ 正しい
4. 修正後にマージ                     ← ✅ 品質担保
```

### 範囲外と判断してよいケース

`ci_monitor_ts` が自動分類するが、手動判断が必要な場合:

| 分類 | 条件 | 対応 |
| ---- | ---- | ---- |
| **範囲内** | PRで変更したファイルへの指摘 | このPRで修正 |
| **範囲内** | PR目的に直接関係する改善 | このPRで修正 |
| **範囲外** | 未変更ファイルへの既存バグ | Issue作成 |
| **範囲外** | 大規模リファクタリング提案 | Issue作成 |
| **範囲外** | アーキテクチャ変更提案 | Issue作成 |

**判断に迷ったら**:
- 修正が5行以内 → 範囲内として対応
- 修正が複数ファイルに波及 → Issue作成
- PRスコープが大きくなりすぎる → Issue作成

### 改善レベル vs 追加開発レベルの判断（Issue #3828）

AIレビュー指摘を「False positive」として却下する前に、改善レベルかどうかを検討する。

| レベル | 定義 | 対応 |
| ------ | ---- | ---- |
| **改善レベル** | 小さな変更、防御的プログラミング、コードスタイル改善 | 同じPRで対応 |
| **追加開発レベル** | 新機能、大きなリファクタリング、スコープ外の変更 | 別Issue作成 |

**判断ポイント**:

| 条件 | 判定 |
| ---- | ---- |
| 変更が5行以内 | 改善レベル |
| PRの目的と直接関係ある | 改善レベル |
| 害のない防御的コード追加 | 改善レベル |
| テスト追加が必要（同じPRで実装可能） | 改善レベル |
| テスト追加が必要（複雑/大規模） | 追加開発レベル |
| 複数ファイルに波及する変更 | 追加開発レベル |

**重要**: 「False positive」として却下するのは、**本当に誤検知の場合のみ**。改善レベルの指摘を「不要」として却下しない。

**背景**: PR #3827 でGeminiの `filter(Boolean)` 指摘を「False positive」として却下しようとしたが、改善レベルとして対応すべきだった。

### 「範囲外」判断の厳格化（Issue #1192）

**原則**: 迷ったら修正を優先

「範囲外」と判断する前に以下の基準で評価:

| 状況 | 対応 | 理由 |
| ---- | ---- | ---- |
| **修正可能（数分で対応可能）** | 修正する | 先送りは非効率 |
| **設計変更が必要** | Issue作成 | PRスコープを超える |
| **本当にPRスコープ外** | 「範囲外」+ Issue参照必須 | merge-checkがブロック |

**「範囲外」にしてはいけないケース**:

| 安易な理由 | なぜダメか | 正しい対応 |
| ---------- | ---------- | ---------- |
| 「ドキュメントだから省略形でOK」 | ドキュメントも品質基準の対象 | 修正する |
| 「サンプルコードだから厳密でなくてよい」 | サンプルは模範を示すべき | 修正する |
| 「軽微な問題だから後で」 | 軽微なら数分で修正可能 | 修正する |
| 「今回は時間がない」 | 技術的負債の先送り | 修正する |

**「範囲外」と判断する前のチェック**:

- [ ] このPRで書いたコードのバグではないか？
- [ ] このPRで追加した機能のテストではないか？
- [ ] このPRで追加した機能のエッジケース対応ではないか？
- [ ] このPRで追加した機能の誤検知防止ではないか？

## 機能改善系指摘（P2）の対応

**原則: 「あったほうがいい」改善は実装コストを無視して対応する**

P2（改善推奨）の指摘も積極的に採用する。AGENTS.mdの「実装コスト: 度外視OK」方針に基づく。

| 指摘の種類 | 対応 |
| ---------- | ---- |
| ドキュメント改善 | **即座に実装** |
| コードスタイル改善 | **即座に実装** |
| リファクタリング提案 | 同じPRで実装可能 → **即座に実装**、複雑 → **Issue作成** |
| エッジケース対応提案 | 同じPRで実装可能 → **即座に実装**、複雑 → **Issue作成** |
| テスト追加提案 | 同じPRで実装可能 → **即座に実装**、複雑 → **Issue作成** |

**禁止パターン**:

| ❌ 禁止 | ✅ 正しい対応 |
| ------- | ------------ |
| 「P2なので対応しない」 | あったほうがいいなら実装する |
| 「改善提案は範囲外」 | 同じPRで実装、または即座にIssue作成 |
| 「次回以降で検討」 | Issue作成してから発言 |

### MEDIUM問題（P2）の発生源判断（Issue #2904）

P2指摘に対しては、(1) まず「問題の発生源（このPRか／既存コードか）」を判定しスコープを決めたうえで、(2) 上記の改善種別ルールを適用し、具体的な対応内容を決定する。

| 問題の発生源 | 対応 | 理由 |
| ------------ | ---- | ---- |
| **このPRで導入** | 修正 or 設計判断としてIssue作成 | バグ同様、このPRで対応すべき |
| **既存コード** | Issue作成（このPRでは修正しない） | PRスコープ外 |

## 対応フロー

1. コメント内容を確認
2. **AIレビュー指摘の検証**（[response-templates.md](response-templates.md)のチェックリスト参照）
3. **範囲内/範囲外を判断**（ci_monitor_tsの分類を参照）
4. **ultrathink** して評価（妥当か、修正すべきか、却下すべきか）
5. 修正 or 却下理由をコメント
6. Resolveする
7. **レビュー品質を記録**（下記参照）

## レビュー品質の記録（Issue #610）

レビューコメントへの対応結果を記録し、AIレビューの品質を追跡する。

**自動記録**: 以下は自動でログに記録される
- Copilot/Codex Cloud のコメント → `ci_monitor_ts` が REVIEW_COMPLETED 時に記録
- Codex CLI のコメント → `codex_review_output_logger.py` が実行後に記録

**手動記録**: 対応結果（resolution/validity）は以下のスクリプトで記録

```bash
# 採用した場合
bun run .claude/scripts/record_review_response.ts \
  --pr {PR} --comment-id {COMMENT_ID} --resolution accepted

# 却下した場合（理由付き）
bun run .claude/scripts/record_review_response.ts \
  --pr {PR} --comment-id {COMMENT_ID} --resolution rejected \
  --validity invalid --reason "誤検知: 既存コードで問題なし"

# Issue作成した場合
bun run .claude/scripts/record_review_response.ts \
  --pr {PR} --comment-id {COMMENT_ID} --resolution issue_created --issue {ISSUE_NUMBER}

# カテゴリを上書き（自動推定が不正確な場合）
bun run .claude/scripts/record_review_response.ts \
  --pr {PR} --comment-id {COMMENT_ID} --resolution accepted --category security
```

**分析**: レビュー品質の統計を確認

```bash
# サマリー表示
python3 .claude/scripts/analyze_review_quality.py

# レビュアー別統計
python3 .claude/scripts/analyze_review_quality.py --by-reviewer

# カテゴリ別統計
python3 .claude/scripts/analyze_review_quality.py --by-category

# 期間指定
python3 .claude/scripts/analyze_review_quality.py --since 2025-12-01

# JSON出力
python3 .claude/scripts/analyze_review_quality.py --json
```

## コメントのシンプルさを維持

コードコメントは、Why（なぜ）に関する**本質的な説明のみ**を含める。レビュー分類（P0-P3）や対応経緯などのメタ情報は含めない。

| ✅ 良い例 | ❌ 悪い例 |
| --------- | --------- |
| `// parseエラーの場合はcomparison failure` | `// P1対応: parseエラーの場合はcomparison failure` |
| `// Bun.stdin.text()を使用してUTF-8破損を防ぐ` | `// P2対応: Bun.stdin.text()を使用` |
| `// HACK: Issue #123の回避策（APIの制限による）` | `// #123` |

**含めない情報**:

| 不要な情報 | 理由 |
| ---------- | ---- |
| レビュー優先度（P0-P3） | レビュー時の一時的な分類 |
| 「〜対応:」プレフィックス | 修正経緯はgit履歴で追跡可能 |
| 理由なしのIssue/PR番号のみ | 番号だけでは何の問題か不明 |

## 冗長コード検出パターン

レビュー時に注意すべき冗長なコードパターン。

### Python

| パターン | 問題 | 修正 |
| -------- | ---- | ---- |
| `patch.dict(os.environ, {}, clear=True)` + `os.environ.pop(key, None)` | `clear=True`で既に空 | `pop`を削除 |
| `if x is not None: return x` + `return None` | 冗長な分岐 | `return x`のみ |
| `x = []; for item in items: x.append(item)` | リスト生成を簡潔に | `x = list(items)` |
| `try: ... except Exception: pass` | 例外を握りつぶし | 適切なログ/エラー処理を追加 |

### TypeScript/JavaScript

| パターン | 問題 | 修正 |
| -------- | ---- | ---- |
| `if (x !== null && x !== undefined)` | オプショナルチェーンで簡潔に | `if (x != null)` または `x?.` |
| `arr.filter(x => x).length > 0` | `some`で簡潔に | `arr.some(x => x)` |
| `Object.keys(obj).length === 0` | 直接判定可能 | `!Object.keys(obj).length` |
| `async () => { return await ... }`（※try/catch外） | 不要なawait | `async () => { return ... }` |

### テストコード

| パターン | 問題 | 修正 |
| -------- | ---- | ---- |
| モック設定後に同じ値を再設定 | 冗長な設定 | 一度だけ設定 |
| `setUp`で設定したものを各テストで再設定 | 重複設定 | `setUp`のみで設定 |
| 使われない変数の宣言 | 未使用コード | 削除または`_`プレフィックス |

### レビュー時のチェックポイント

- [ ] `clear=True` や `reset=True` 後の手動クリア処理はないか
- [ ] 同じ処理を複数回実行していないか
- [ ] ワンライナーで書けるものを複数行で書いていないか
- [ ] 到達不能なコード（early returnの後のコード等）はないか
