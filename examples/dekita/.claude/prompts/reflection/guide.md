# 振り返りガイド

タスク完了後の自己評価と改善サイクル。

## 振り返り前の情報収集（必須）

**重要**: 記憶に頼らず、客観的な情報を確認してから振り返りを始める。

### 確認すべき情報源

| 情報源 | 確認内容 |
|--------|----------|
| **セッションログ** | ツール呼び出し、フェーズ遷移、タイムライン |
| **作成/マージしたPR** | 今回の成果物（PRの詳細とレビューコメント） |
| **作成したIssue** | 発見した問題（IssueとAIレビュー） |
| **フックによるブロック** | 何回ブロックされ、どう対処したか |

### 振り返り前の手順

1. **セッションログを確認**
   - `.claude/logs/` 以下にセッション単位のログが記録されている
   - セッションIDはフックのJSON入力から取得（`.claude-session` に記録）
   - ログ構成は変更される可能性があるため、最新の構成は `.claude/` を確認

2. **PR/Issueの詳細を確認**

```bash
# PRの詳細とレビューコメント
gh pr view <PR番号> --comments

# Issueの詳細とAIレビュー
gh issue view <Issue番号> --comments
```

### ログ不足時の対応

振り返りに必要な情報がログに記録されていない場合:

1. **即座にIssueを作成**
   - 何の情報が不足しているかを明記
   - 再現手順（どの振り返り操作で発覚したか）を記載
   - 既存のログ改善Issue（例: #1840）があれば、そちらに追記も検討

```bash
# ログ改善Issueを作成
gh issue create \
  --title "fix(logs): 振り返りに必要な情報が記録されていない" \
  --label "bug,P2" \
  --body "## 不足している情報
- [具体的に何が不足しているか]

## 発覚した経緯
振り返り時に確認しようとしたが、期待する情報が得られなかった

## 期待する動作
[何が記録されているべきか]"
```

2. **今回の振り返りは記憶ベースで実施**（次善策）
   - ただし「ログ不足のため記憶ベース」と明記する
   - 次回以降はログベースで振り返れるよう、Issue対応を優先

### 振り返り出力テンプレート

以下のテンプレートをコピーして使用:

```markdown
## セッション概要

- **日時**: YYYY-MM-DD HH:MM - HH:MM
- **セッションID**: [.claude-sessionから取得]
- **成果物**: PR #XXX, Issue #XXX（マージ済み/オープン）

## 今回のセッションで行った作業

1. [作業1の説明] (PR/Issue番号)
2. [作業2の説明] (PR/Issue番号)

## 五省

1. **要件理解に悖るなかりしか**
   - [具体的な評価内容]
   - **反省点**: [あれば記載]

2. **実装に恥づるなかりしか**
   - [具体的な評価内容]
   - **反省点**: [あれば記載]

3. **検証に欠くるなかりしか**
   - [ビルド/テスト/Lint結果]
   - [AIレビュー結果]

4. **対応に憾みなかりしか**
   - [レビューコメント対応状況]

5. **効率に欠くるなかりしか**
   - [ワークフロー評価]
   - **反省点**: [あれば記載]

## 反省点と対策

| 反省点 | 対策 | 優先度 | Issue（あれば） |
|--------|------|--------|----------------|
| [具体的な反省点] | [仕組み化/ドキュメント化] | 高/中/低 | [あればIssue番号] |

## 次のセッションへの引き継ぎ

- [未完了タスク]
- [注意すべき点]
```

**必須項目**:
- セッションID（ログ追跡用）
- PR/Issue番号（客観的な参照）
- 反省点がある場合はIssue番号（仕組み化の証跡）

### 良い振り返りの例

```markdown
## 今回のセッションで行った作業

- PR #1843: coding-standardsにテストケースルールを追加（マージ済み）
- Issue #1844: 振り返りガイドの改善提案を作成

## 五省

1. **要件理解に悖るなかりしか**
   - Issue #1841の要求は明確だった
   - ただし、AIレビューで「再現手順がない」と指摘された（確認不足）

2. **実装に恥づるなかりしか**
   - ドキュメント変更のみだったが、具体例を含めた
   - **反省点**: コード例を追加すべきだった

3. **検証に欠くるなかりしか**
   - codex CLIレビューを実行し、問題なし確認
   - CIも全てパス

4. **対応に憾みなかりしか**
   - レビュー指摘なし（ドキュメントのみのため）

5. **効率に欠くるなかりしか**
   - worktree作成→編集→PR→マージの流れはスムーズ
   - **反省点**: 振り返り時に形式的な評価をしてしまった

## 反省点と対策

| 反省点 | 対策 | 優先度 |
|--------|------|--------|
| 振り返りが形式的 | Issue #1844で仕組み化 | 高 |
```

### 悪い振り返りの例（アンチパターン）

```markdown
## 五省

1. ✅ 問題なし
2. ✅ 問題なし
3. ✅ 問題なし
4. ✅ 問題なし
5. ✅ 問題なし

総評: 特に問題なく完了しました。
```

**なぜダメか**:
- 具体的な作業内容の言及がない
- 客観的な情報（PR番号、Issue番号）を参照していない
- 「問題なし」の根拠が示されていない
- 「何か問題があったはず」という前提で始めていない

## 五省（AIエージェント版）

タスク完了時に5つの問いで自己評価:

1. **要件理解に悖（もと）るなかりしか**
   - ユーザーの要求を正確に理解したか
   - 曖昧な点を確認せず進めなかったか

2. **実装に恥づるなかりしか**
   - コード品質は十分か
   - テスト・ドキュメントは適切に追加したか

3. **検証に欠くるなかりしか**
   - ビルド・テスト・Lintを確認したか
   - レビューコメントを見落としていないか

4. **対応に憾みなかりしか**
   - レビュー指摘を慎重に評価したか
   - 全てに対応したか

5. **効率に欠くるなかりしか**
   - 無駄な作業はなかったか
   - 並列実行・sub-agentを活用したか

## 反省点の対策

反省点は「ドキュメント化」または「仕組み化」する:

| 対策         | 優先度   | 例                     |
| ------------ | -------- | ---------------------- |
| 仕組み化     | **高**   | フック、CI、ツール     |
| ドキュメント化 | 低       | AGENTS.md追記          |

**重要**: ドキュメント追加だけでは問題は解決しない。仕組み化を優先。

## なぜなぜ分析（5 Whys）

問題発生時に根本原因を特定:

```text
問題: [発生した問題]

なぜ1: [直接的な原因]
なぜ2: [なぜ1の原因]
なぜ3: [なぜ2の原因]
なぜ4: [なぜ3の原因]
なぜ5: [根本原因]

対策: [根本原因への対策]
```

**ポイント**:

- 個人ではなくプロセス・仕組みに焦点
- 5回は目安、根本原因に到達したら終了
- 再発防止策に繋げる

## 振り返りのアンチパターン

❌ **チェックリスト症候群**

- ✅マークを並べて「問題なし」とする
- 形式的に項目を埋めるだけ

❌ **完了急ぎ症候群**

- 「完了しました」を急いで振り返りを省略

❌ **前提バイアス**

- 「問題がなかった」前提で始める

❌ **「完璧です」と言う**

- 完璧な状態は存在しない
- 正しい表現: 「現時点で気づいている反省点は全て対応しました」

## 正しい振り返りの姿勢

1. **「何か問題があったはず」**という前提で始める
2. 最低**3回「他にないか？」**と自問する
3. ✅マークではなく具体的な行動と改善点を記述
4. 反省点はドキュメント化 **または** 仕組み化

## トラブルシューティング原則

1. エラー ≠ 失敗と決めつけない（実際の状態を確認）
2. 推測より先に設定・環境を確認
3. 仮説は実際に検証
4. 引き継ぎ情報も一次情報で裏付け
5. CIエラーは即座にワークフロー内容を確認

## 仕組み化の例

| 問題                     | 仕組み化                        |
| ------------------------ | ------------------------------- |
| mainで編集してしまう     | Edit/Writeブロックフック        |
| レビューコメント見落とし | マージ安全性チェックフック      |
| コミット前の検証漏れ     | python-lint-check, ui-check-reminder |
| ドキュメント肥大化       | markdown-size-checkフック       |
