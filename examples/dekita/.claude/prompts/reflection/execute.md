## 0. 必須チェック（最初に実行）

**重要**: 以下を**必ず**実行してから振り返りを開始。形式的な振り返りを防ぐため、各項目で具体的な記述を要求します。

| チェック項目 | 実行内容（記述必須） |
|-------------|---------------------|
| **前提バイアス回避** | 「問題があったはず」という前提で始める。「問題なし」で始めない |
| **調査の網羅性** | 関連する全ディレクトリを調査したか？漏れた箇所があれば記述 |
| **3回自問** | 「他にないか？」を3回自問し、検討した観点を記述 |

**参照**: guide.md の「正しい振り返りの姿勢」セクション（L250-255）

```markdown
1. 「何か問題があったはず」という前提で始める
2. 最低3回「他にないか？」と自問する
3. ✅マークではなく具体的な行動と改善点を記述
4. 反省点はドキュメント化 **または** 仕組み化
```

---

## 1. このセッションの行動振り返り

今回のセッションで実行した主要アクティビティを振り返ってください：

| カテゴリ | 確認項目 |
|---------|---------|
| **実施タスク** | 何を依頼され、何を実施したか |
| **worktree操作** | 作成・削除したworktree |
| **PR操作** | 作成、レビュー対応、マージしたPR |
| **Issue操作** | 作成、更新、クローズしたIssue |
| **Skill使用** | 使用したSkill（code-review, development-workflow等） |
| **ブロック対応** | 遭遇したブロックとその回避方法 |

## 2. ログによる調査（必須）

**重要**: ログ確認は必須です。ログから潜在的な問題を発見できることがあります（Issue #1863 はログ確認で発見されました）。

以下のコマンドを実行してログを確認してください：

### 現在セッションのログ抽出

セッションIDはセッション開始時に `[CONTEXT]` メッセージで表示されます（形式: `Session: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）。

表示されていない場合は、最新の状態ファイルから取得:

```bash
SESSION_ID=$(ls -t .claude/logs/flow/state-*.json 2>/dev/null | head -1 | sed 's/.*state-\(.*\)\.json/\1/')
```

セッション固有のログを直接参照（Issue #1994でセッション毎ファイル形式に変更）:

```bash
# セッション固有のフック実行ログ
cat ".claude/logs/execution/hook-execution-$SESSION_ID.jsonl"

# セッション固有のフロー状態
cat ".claude/logs/flow/state-$SESSION_ID.json"
```

### 利用可能なログ一覧

| ディレクトリ | ファイル | 用途 | 生成タイミング |
|-------------|----------|------|---------------|
| `execution/` | `hook-execution-{session_id}.jsonl` | セッション毎のフック実行履歴（approve/block両方） | 全フック実行時 |
| | `hook-errors.log` | 全セッションのブロック記録（集約） | block判定時 |
| | `hook-warnings.log` | 警告記録 | 警告出力時 |
| | `api-operations-{session_id}.jsonl` | セッション毎のGitHub API操作ログ | gh/git API呼び出し時 |
| | `git-operations.log` | Git操作ログ | git操作時 |
| `flow/` | `events.jsonl` | フロー状態遷移 | フェーズ変更時 |
| | `state-{session_id}.json` | セッション状態 | 状態変更時 |
| `metrics/` | `behavior-anomalies.jsonl` | 行動異常検出（偽陽性含む） | 異常検出時 |
| | `block-patterns.jsonl` | ブロックパターン分析 | セッション終了時 |
| | `session-metrics.log` | セッションメトリクス | セッション終了時 |
| | `tool-efficiency-metrics.log` | ツール効率 | ツール使用時 |
| `reports/` | `session-*.json` | セッションレポート | セッション終了時 |

### 典型的な分析クエリ

```bash
# 現在セッションのブロック理由を確認
cat ".claude/logs/execution/hook-execution-$SESSION_ID.jsonl" | jq -r 'select(.decision == "block") | .reason'

# 現在セッションの状態確認
jq '.workflows.main.current_phase' ".claude/logs/flow/state-$SESSION_ID.json"

# 特定フックのブロック回数（現在セッション）
cat ".claude/logs/execution/hook-execution-$SESSION_ID.jsonl" | jq -r 'select(.decision == "block") | .hook' | sort | uniq -c

# 全セッションのブロックパターン
cat .claude/logs/metrics/block-patterns.jsonl | jq -r '.hook' | sort | uniq -c | sort -rn
```

### Skill使用状況の確認

セッション中に使用したSkillをtranscriptから抽出します:

```bash
# transcriptファイルのパス（SESSION_IDから特定）
TRANSCRIPT=$(ls -t ~/.claude/projects/*/sessions/"$SESSION_ID"/transcripts/*.jsonl 2>/dev/null | head -1)

# 使用されたSkill一覧
cat "$TRANSCRIPT" | jq -r 'select(.message.content[]?.name == "Skill") | .message.content[] | select(.name == "Skill") | .input.skill' | sort | uniq -c

# Skill呼び出しの詳細（引数含む）
cat "$TRANSCRIPT" | jq -r 'select(.message.content[]?.name == "Skill") | .message.content[] | select(.name == "Skill") | "\(.input.skill): \(.input.args // "(引数なし)")"'
```

**確認すべき項目**:

| 確認項目 | 質問 |
|---------|------|
| **使用タイミング** | 適切なタイミングでSkillを使用したか？ |
| **使用漏れ** | 使用すべきだったが使用しなかったSkillはないか？ |
| **効果** | Skill使用により効率化・品質向上に繋がったか？ |

**よくある使用漏れパターン**:

| 状況 | 使用すべきSkill |
|------|----------------|
| worktree作成・PR作成時 | `development-workflow` |
| レビューコメント対応時 | `code-review` |
| セッション終了時 | `reflect` |
| フック実装・修正時 | `hooks-reference` |

### ログ分析の必須チェック（Issue #1996）

**重要**: ログを「表示して終わり」にしない。以下のチェックを必ず実行してください。

| チェック項目 | 確認内容 | 具体例 |
|-------------|----------|--------|
| **タイムスタンプ分析** | 同じフックが30秒以内に2回以上ブロックしていないか | `09:37:05 block(resolve-thread-guard)` → `09:37:15 block(resolve-thread-guard)` = 即時再試行の疑い |
| **パターン検出** | 同じ対象（ファイル、スレッドID等）への連続操作がないか | Thread `PRRT_xxxT9` に2回連続ブロック = 根本原因を解消していない |
| **因果関係** | 各ブロック後、原因を解消したか、回避しただけか | `resolve-thread-guard` 後、コメントを追加せず即再試行 = NG |
| **ppidベースログ検出**（Issue #2529） | `ppid-` プレフィックスのログファイルが存在しないか | `hook-execution-ppid-*.jsonl` = session_id伝播の問題 |

**分析コマンド例**:

```bash
# 同一セッションのブロックをタイムスタンプ順に確認
cat ".claude/logs/execution/hook-execution-$SESSION_ID.jsonl" | jq -r 'select(.decision == "block") | [.timestamp, .hook, .details.thread_id // .details.command // ""] | @tsv'
```

**完了条件**:

- [ ] 上記3項目を全て確認した
- [ ] 異常パターンを発見した場合はIssue起票した（または「なし」を明記）

### 過去セッションのログ確認

セッション毎にファイルが分離されているため（Issue #1994）、過去セッションのログは直接参照できます:

```bash
# 利用可能なセッションログ一覧
ls -lt .claude/logs/execution/hook-execution-*.jsonl | head -10

# 特定のセッションログを確認
cat .claude/logs/execution/hook-execution-{過去のセッションID}.jsonl | jq .
```

**ログ不足の確認**: 調査に必要なログが不足している場合、ログ追加のIssueを作成してください。

### セクション2の観点チェック

このセクション完了時に以下を確認:

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **セッション事実** | ログを確認し、客観的事象を把握したか | [ ] |
| **異常パターン** | 通常と異なる動作（繰り返し、タイムアウト等）を確認したか | [ ] |
| **Skill使用の適切性** | 適切なタイミングでSkillを使用したか。使用漏れはないか | [ ] |

**Skill使用の評価例**:

```markdown
### Skill使用の評価
- 使用したSkill: `code-review`（PR #1234のレビュー対応）
- 使用しなかったSkill:
  - `development-workflow`: worktree作成時に使用すべきだった → 手順を忘れてブロックされた
  - `reflect`: セッション終了時に使用すべきだった → 指摘されるまで忘れていた
- 改善点: Skill説明を再確認し、適切なタイミングで使用する
```

## 3. PR/Issue実装評価（必須）

**重要**: セッション中に作成したPR/Issueの**実装内容**を評価します。数値（コミット数、レビュー数）ではなく、**Issue要件とPR実装の対応関係**を確認してください。

**対象**: セクション1で確認したPR/Issueが評価対象です。

### 3.1 Issue要件の抽出（最初に実行）

各Issueについて、**本文を実際に読んで**要件を抽出してください：

```bash
# Issue本文を読む（必須）
gh issue view <Issue番号>
```

**抽出すべき項目**:

| 抽出項目 | 確認内容 |
|---------|---------|
| **明示的要件** | Issue本文に書かれた「〜する」「〜を追加」などの要件 |
| **チェックリスト** | `- [ ]` 形式のタスク一覧 |
| **対応案** | 「対応案」セクションに書かれた実装方針 |
| **暗黙の要件** | 明示されていないが当然必要な事項（テスト追加など） |

**記録例**:

```markdown
### Issue #2251 の要件
1. reflection-self-checkを警告型からブロック型に変更
2. 観点が欠けている場合にexit code 2を返す
3. （暗黙）テストを新しい動作に合わせて更新
```

### 3.2 PR実装内容の確認

各PRについて、**変更内容を実際に読んで**実装範囲を確認してください：

```bash
# PRの説明を読む
gh pr view <PR番号>

# 変更ファイル一覧
gh pr view <PR番号> --json files --jq '.files[].path'

# 変更差分のサマリー（大きい場合）
gh pr diff <PR番号> --stat
```

**確認すべき項目**:

| 確認項目 | 質問 |
|---------|------|
| **変更範囲** | どのファイルが変更されたか？ |
| **実装内容** | 何が実装されたか？（PRの説明から） |
| **テスト** | テストは追加/更新されたか？ |

### 3.3 要件と実装の突合せ（核心）

**Issue要件とPR実装を1対1で対応させ、漏れがないか確認**してください：

| Issue要件 | PR実装 | 状態 |
|----------|--------|------|
| 例: ブロック型に変更 | ✓ make_block_result使用、exit(2)追加 | 完了 |
| 例: テスト更新 | ✓ test_blocks_for_missing_perspectivesに変更 | 完了 |
| 例: エッジケース対応 | ✗ 未実装 | **要対応** |

**漏れ発見時の対応**:

- 未実装項目 → 新Issueを作成するか、既存Issueを再オープン
- 部分実装 → 残作業をIssueにコメント

### 3.4 レビューコメントの確認

PRのレビューコメントを**実際に読んで**、対応状況を確認してください：

```bash
# コードレビューコメント（コード行への指摘）
gh api repos/:owner/:repo/pulls/<PR番号>/comments --jq '.[] | {path: .path, body: .body}'

# 会話コメント（PR全体へのコメント）
gh pr view <PR番号> --json comments --jq '.comments[] | {author: .author.login, body: .body}'
```

**確認すべき項目**:

| 確認項目 | 質問 |
|---------|------|
| **指摘内容** | どんな指摘があったか？ |
| **対応状況** | 各指摘に対応したか？ |
| **対応の妥当性** | 対応は適切だったか？（形式的に解決していないか） |

**評価結果記録**:

| PR | 対応Issue | 要件充足 | レビュー対応 | 評価 |
|----|----------|---------|-------------|------|
| #xxx | #yyy | 3/3完了 | 2件対応済み | 良好 |
| #xxx | #yyy | 2/3完了 | 1件未対応 | **要フォローアップ** |

### 3.5 総合評価

上記の評価結果を集計し、以下の問いに回答:

1. **要件充足**: 全Issueの要件が100%実装されたか？
2. **レビュー対応**: 全レビューコメントに適切に対応したか？
3. **品質**: レビュー指摘からどんな傾向が見えるか？（型エラー多発、テスト不足など）

**問題発見時の対応**:

- 未完了のIssue要件 → 新Issueを作成するか、既存Issueを再オープン
- 未対応のレビューコメント → 対応してコミットするか、理由を記載してresolve
- レビュー指摘の傾向 → 改善点としてセクション7でIssue化

### セクション3の観点チェック

このセクション完了時に以下を確認:

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **実装後の動作確認** | マージ後に動作を確認したか。正常系・異常系・Dogfoodingの3点を実施したか | [ ] |

**実装後の動作確認の例**:

```markdown
### 実装後の動作確認
- 実施した確認:
  - 正常系: マージ後にフックが発火し、期待通りのメッセージが表示された
  - 異常系: worktree削除済みの場合もオリジナルリポジトリへの誘導が表示された
  - Dogfooding: 自分のPRマージで実際に動作確認した
- 確認結果: 問題なし
```

**典型的な問題**:

| 問題パターン | 例 |
|-------------|-----|
| 確認なしで完了宣言 | 「マージしました」→ 動作確認なし |
| 正常系のみ確認 | ハッピーパスは動くがエラー時に問題 |
| 実データ未使用 | テストデータでは動くが実データで失敗 |
| Dogfooding省略 | 他人が使う想定だが自分で使っていない |

## 4. 開発フローの評価（五省）

@.claude/prompts/reflection/guide.md の「五省」に基づき、以下を自己評価してください：

| 観点 | チェック項目 |
|------|-------------|
| **要件理解** | ユーザーの要求を正確に理解したか |
| **効率** | 無駄な作業、手戻りはなかったか |
| **対応** | ブロックや問題に適切に対処したか |
| **完遂** | タスクをマージまで完遂したか |

## 5. 自律完遂度の評価

**目的**: セッション中にユーザーの介入なしで完遂できたかを評価し、開発フローの改善点を発見する。

### 5.1 中断イベントの抽出

セッション中に発生した以下のイベントをリストアップしてください：

| 中断タイプ | 検出方法 | 例 |
|-----------|----------|-----|
| **フックブロック** | ログから抽出 | `exit 2` によるブロック |
| **AskUserQuestion使用** | 記憶から抽出 | 選択肢の提示、確認 |
| **ユーザー指示待ち** | 記憶から抽出 | 「〜しますか？」「どうしますか？」 |
| **エラー報告・相談** | 記憶から抽出 | 問題発見時のユーザーへの報告 |

**ログからの抽出コマンド**:

```bash
# フックブロック一覧
cat ".claude/logs/execution/hook-execution-$SESSION_ID.jsonl" | jq -r 'select(.decision == "block") | "\(.timestamp // "unknown") | \(.hook // "unknown") | \(.reason // "理由なし")"'
```

**出力形式**（必須）:

```markdown
### 中断イベント一覧

| # | タイプ | 内容 | 対応 |
|---|--------|------|------|
| 1 | フックブロック | main-branch-edit-guard: mainでのEdit禁止 | worktree作成して回避 |
| 2 | AskUserQuestion | 実装方式A/Bの選択を確認 | ユーザーがAを選択 |
| 3 | ユーザー指示待ち | 「PRをマージしますか？」と確認 | ユーザー承認後マージ |
```

**中断なしの場合**: 「中断イベントなし」と明記。

### 5.2 中断の適切性評価

各中断について、**必要な中断**か**不要な中断**かを評価してください：

| 判定 | 基準 | 例 |
|------|------|-----|
| **必要** | セキュリティ、破壊的操作、重大な選択肢 | 本番データ削除の確認、複数アーキテクチャ案の選択 |
| **不要** | 自動化可能、ルール明確化で回避可能 | mainブランチでの編集（worktree自動作成で回避可能）、マージ確認（AGENTS.mdで自動マージ指示あり） |

**出力形式**:

```markdown
### 適切性評価

| # | 判定 | 理由 |
|---|------|------|
| 1 | **不要** | AGENTS.md/Skillsのルールに従い、事前にworktreeを作成すべきだった |
| 2 | 必要 | ユーザーの意図確認が必要な選択だった |
| 3 | **不要** | AGENTS.mdに「マージまで完遂」の指示があり、確認は不要だった |
```

### 5.3 不要な中断への対策

**不要な中断**が見つかった場合、以下のアクションを実行してください：

| 根本原因 | 対策 |
|----------|------|
| ルールの認識不足 | AGENTS.md/Skillsを再読してルールを確認 |
| ルールの不明確さ | ルール明確化のIssueを作成 |
| フック設計の問題 | フック改善のIssueを作成 |
| 自動化の欠如 | 自動化フック/スクリプトのIssueを作成 |

**Issue作成時のラベル**: `enhancement`, `developer-experience`

**出力形式**:

```markdown
### 対策

| 不要な中断 | 根本原因 | 対策 | Issue |
|-----------|----------|------|-------|
| マージ確認 | AGENTS.mdルールの認識不足 | ルール再確認（Issue不要） | - |
| worktree作成確認 | 自動化の欠如 | 自動worktree作成フック | #xxx |
```

### 5.4 自律完遂度スコア

以下の計算式でスコアを算出してください：

```
必要な中断数 = 総中断数 - 不要な中断数

自律完遂度 =
  - 総中断数 > 0 の場合: 必要な中断数 / 総中断数 × 100%
  - 総中断数 = 0 の場合: 100%
```

※小数点以下は切り捨てて、整数パーセントで記載する（例: 66.6...% → 66%）。

- **100%**: 全ての中断が必要だった（理想）
- **80%以上**: 良好
- **80%未満**: 改善が必要（Issue作成必須）

**中断なしの場合**: 「100%（中断なし）」と記載。

**スコアが80%未満の場合**:

1. 不要な中断の根本原因を「なぜなぜ分析」で深掘り
2. 改善Issueを**必ず**作成
3. 次回セッションで改善を確認

### セクション5の観点チェック

このセクション完了時に以下を確認:

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **自律完遂度** | 中断イベントを全て抽出し、適切性を評価したか。不要な中断があれば対策をIssue化したか | [ ] |

**自律完遂度の評価例**:

```markdown
### 自律完遂度の評価
- 中断イベント: 3件（フックブロック1件、AskUserQuestion1件、ユーザー指示待ち1件）
- 適切性評価:
  - フックブロック: **不要**（AGENTS.mdのルールに従い、事前にworktreeを作成すべきだった）
  - AskUserQuestion: 必要（実装方式の選択）
  - ユーザー指示待ち: **不要**（「マージしますか？」の確認はAGENTS.mdルールに反する）
- 自律完遂度スコア: 33%（1/3が必要な中断）
- 対策: ルール再確認（AGENTS.md「マージまで完遂」「worktree作成」を再読）
```

## 6. 改善点の洗い出し

以下の観点で問題を特定してください：

- 開発フローで非効率だった点
- 遭遇した問題とその根本原因
- 仕組み化すべき改善点
- **自律完遂度の低下要因**（セクション5で発見した不要な中断）

### 教訓の記録方法（Issue #2311）

**重要**: 教訓や改善点を発見したら、`[lesson]` タグを使って明示的にマークしてください。

**タグ形式**:

```markdown
[lesson] 教訓の内容 → Issue #番号
```

**例**:

```markdown
[lesson] 根本原因を調査せずに表面的な対応をした → Issue #xxxx
[lesson] ログ確認を後回しにして問題を見逃した → Issue #yyyy
```

**ルール**:

| 条件 | 動作 |
|------|------|
| `[lesson]` タグあり、Issue参照なし | **ブロック**（Issue化必須） |
| キーワードのみ（タグなし） | 警告（ブロックしない） |
| `[lesson]` タグあり、Issue参照あり | 正常（通過） |

**注意**: 「教訓」「改善点」「反省点」等のキーワードだけでは警告のみ。確実にIssue化を強制するには `[lesson]` タグを使用してください。

### 仕組み化の完成度チェック

「仕組み化」を謳うIssueをクローズした場合、以下を確認：

| チェック項目 | 確認内容 |
|-------------|----------|
| **ドキュメント** | AGENTS.md等にルールが追記されているか |
| **強制機構** | フック/CI/ツールで違反が自動的にブロックされるか（警告のみは不十分） |

**重要**: ドキュメント追加だけでは「仕組み化完了」とは言えない。強制機構がなければ再発防止にならない。

### セクション6の観点チェック

このセクション完了時に以下を確認:

| 観点 | 確認内容 | チェック |
|------|----------|---------|
| **根本原因** | 表面的な説明で終わらず、なぜなぜ分析をしたか | [ ] |
| **見落とし** | 「他にないか？」を3回自問したか | [ ] |
| **安易な判断** | 「問題なし」と判断する前に十分検討したか | [ ] |
| **Issue化** | 発見した問題をIssue化したか（または不要な理由を明記したか） | [ ] |
| **「対応済み」検証** | 「対応済み」と判断した場合、その仕組みの実行タイミングを確認し、実際に有効か検証したか | [ ] |
| **振り返り自体の評価** | この振り返り自体に改善点はないか、形式的なチェックリスト消化になっていないか | [ ] |

**「対応済み」検証の例**:

```markdown
### 「対応済み」判断の検証
- 「post-merge-reflection-enforcerで対応済み」と判断
- 実行タイミング確認: Post（マージ後）
- 今回の問題: マージ前のユーザー確認待ち
- 検証結果: **無効**（タイミングが合わない）→ Issue化必要
```

**振り返り自体の評価例**:

```markdown
### 振り返り自体の評価
- 形式的になっていないか: チェックリストを埋めることが目的化していた
- 改善点: 「なぜ」を3回問う前に結論を出してしまった
- メタ振り返り: 振り返りプロセス自体にも改善の余地がある
```

## 7. Issue作成（必須）

**重要**: 改善点が見つかった場合、**severity に関わらず全てIssue化が必須**です（Issue #1869）。

発見した改善点について：
- 1つの問題につき1つのIssueを作成
- 再現手順と期待動作を含める
- 適切なラベルを付与
- **自律完遂度の改善Issue**も含める（セクション5.3参照）

## 8. 最終確認（全観点サマリー）

**重要**: 各セクションで観点チェックを実施した後、振り返り全体を俯瞰して最終確認を行ってください。

### 観点チェック完了確認

以下の観点が各セクションで確認されているかを確認:

| セクション | 主な確認項目 | 完了 |
|-----------|-------------|------|
| 2. ログ調査 | セッション事実、異常パターン、Skill使用 | [ ] |
| 3. PR/Issue評価 | 実装後の動作確認 | [ ] |
| 4. 開発フロー | 五省による自己評価 | [ ] |
| 5. 自律完遂度 | 中断イベントの評価 | [ ] |
| 6. 改善点 | 根本原因、見落とし、安易な判断、Issue化、対応済み検証、振り返り自体の評価 | [ ] |
| 7. Issue作成 | 全改善点のIssue化 | [ ] |

### 振り返り全体の評価

以下の質問に答えてください:

1. **網羅性**: 全セクションを実施し、スキップしたものはないか
2. **深さ**: 表面的な確認で終わらず、本質的な問題を掘り下げたか
3. **行動**: 発見した問題に対して具体的なアクション（Issue作成等）を実行したか

**注意**: 抜けている観点がある場合、該当セクションに戻って補完してください。

**補足**: セッション終了時に `reflection-self-check` フックが自動で観点チェックの完了を確認します（Issue #2242）。
