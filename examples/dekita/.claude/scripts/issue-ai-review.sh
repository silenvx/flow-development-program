#!/bin/bash
# Geminiã¨Codexã§Issueã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã™ã‚‹ã€‚
#
# Why:
#     AIã«ã‚ˆã‚‹Issueãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•åŒ–ã—ã€
#     å•é¡Œã®æ˜ç¢ºã•ã‚„æŠ€è¡“çš„å®Ÿç¾æ€§ã‚’äº‹å‰ã«æ¤œè¨¼ã™ã‚‹ãŸã‚ã€‚
#
# What:
#     - run_gemini_review(): Gemini CLIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
#     - run_codex_review(): Codex CLIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
#     - gh issue comment: ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’æŠ•ç¨¿
#
# Remarks:
#     - Usage: issue-ai-review.sh <issue_number>
#     - ä¸¦åˆ—å®Ÿè¡Œã§ä¸¡æ–¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
#     - CLIãŒç„¡ã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆgraceful degradationï¼‰
#     - set -eã‚’ä½¿ç”¨ã—ãªã„ã®ã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãŸã‚
#
# Changelog:
#     - silenvx/dekita#1600: Issueã®AIãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’è¿½åŠ 

# Note: We use set -uo pipefail but not -e because we handle errors explicitly
# with || patterns for graceful degradation when AI tools are unavailable
set -uo pipefail

ISSUE_NUMBER="${1:-}"
if [[ -z "$ISSUE_NUMBER" ]]; then
    echo "Usage: $0 <issue_number>" >&2
    exit 1
fi

# Get issue content (using jq to safely escape all values)
ISSUE_JSON=$(gh issue view "$ISSUE_NUMBER" --json title,body,labels 2>/dev/null) || {
    echo "Failed to fetch issue #$ISSUE_NUMBER" >&2
    exit 1
}

if [[ -z "$ISSUE_JSON" || "$ISSUE_JSON" == "null" ]]; then
    echo "Empty response for issue #$ISSUE_NUMBER" >&2
    exit 1
fi

# Build review prompt using jq to safely handle special characters
# This prevents shell injection from issue title/body content
REVIEW_PROMPT=$(jq -r --arg prompt "$(cat <<'PROMPT_EOF'
ä»¥ä¸‹ã®GitHub Issueã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
1. å•é¡Œã®æ˜ç¢ºã•: å•é¡ŒãŒå…·ä½“çš„ã«èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‹
2. å†ç¾æ‰‹é †: å•é¡Œã‚’å†ç¾ã™ã‚‹ãŸã‚ã®æƒ…å ±ãŒååˆ†ã‹
3. æœŸå¾…å‹•ä½œ: æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œãŒæ˜ç¢ºã‹
4. æŠ€è¡“çš„å®Ÿç¾æ€§: ææ¡ˆã•ã‚ŒãŸè§£æ±ºç­–ã¯å¦¥å½“ã‹
5. å„ªå…ˆåº¦ã®å¦¥å½“æ€§: ãƒ©ãƒ™ãƒ«ã‚„èª¬æ˜ã‹ã‚‰å„ªå…ˆåº¦ã¯é©åˆ‡ã‹

æ”¹å–„ææ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚

---
PROMPT_EOF
)" '
    $prompt + "\n# " + .title + "\n\n" + (.body // "") + "\n\nLabels: " + ([.labels[].name] | join(", "))
' <<< "$ISSUE_JSON")

# Temporary files for parallel execution
GEMINI_RESULT=$(mktemp)
CODEX_RESULT=$(mktemp)
cleanup() {
    rm -f "$GEMINI_RESULT" "$CODEX_RESULT"
}
trap cleanup EXIT

# Sentinel values for detecting failures
readonly GEMINI_UNAVAILABLE="__GEMINI_CLI_NOT_AVAILABLE__"
readonly GEMINI_FAILED="__GEMINI_REVIEW_FAILED__"
readonly CODEX_UNAVAILABLE="__CODEX_CLI_NOT_AVAILABLE__"
readonly CODEX_FAILED="__CODEX_REVIEW_FAILED__"

# Run Gemini review (if available)
run_gemini_review() {
    if ! command -v gemini &>/dev/null; then
        echo "$GEMINI_UNAVAILABLE"
        return 0
    fi
    local output
    if output=$(echo "$REVIEW_PROMPT" | gemini -p "ã‚ãªãŸã¯GitHub Issueãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚ç°¡æ½”ã«æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚" 2>/dev/null); then
        echo "$output"
    else
        echo "$GEMINI_FAILED"
    fi
}

# Run Codex review (if available)
run_codex_review() {
    if ! command -v codex &>/dev/null; then
        echo "$CODEX_UNAVAILABLE"
        return 0
    fi
    local output
    # codex exec reads prompt from stdin when using '-'
    # System instructions are included in the prompt itself
    local codex_prompt="ã‚ãªãŸã¯GitHub Issueãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚ç°¡æ½”ã«æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

$REVIEW_PROMPT"
    if output=$(echo "$codex_prompt" | timeout 120 codex exec - 2>/dev/null); then
        echo "$output"
    else
        echo "$CODEX_FAILED"
    fi
}

# Run reviews in parallel
run_gemini_review > "$GEMINI_RESULT" &
GEMINI_PID=$!

run_codex_review > "$CODEX_RESULT" &
CODEX_PID=$!

# Wait for both to complete (exit status handled by sentinel values)
wait "$GEMINI_PID" 2>/dev/null
wait "$CODEX_PID" 2>/dev/null

GEMINI_OUTPUT=$(cat "$GEMINI_RESULT")
CODEX_OUTPUT=$(cat "$CODEX_RESULT")

# Check if we have any useful review output
gemini_useful=false
codex_useful=false

if [[ "$GEMINI_OUTPUT" != "$GEMINI_UNAVAILABLE" && "$GEMINI_OUTPUT" != "$GEMINI_FAILED" && -n "$GEMINI_OUTPUT" ]]; then
    gemini_useful=true
fi

if [[ "$CODEX_OUTPUT" != "$CODEX_UNAVAILABLE" && "$CODEX_OUTPUT" != "$CODEX_FAILED" && -n "$CODEX_OUTPUT" ]]; then
    codex_useful=true
fi

# Skip posting if neither review produced useful output
if [[ "$gemini_useful" == "false" && "$codex_useful" == "false" ]]; then
    echo "No useful AI review output to post" >&2
    exit 0
fi

# Build comment with only successful reviews
COMMENT="## ğŸ¤– AI Review

"

if [[ "$gemini_useful" == "true" ]]; then
    COMMENT+="### Gemini Review
$GEMINI_OUTPUT

"
fi

if [[ "$codex_useful" == "true" ]]; then
    COMMENT+="### Codex Review
$CODEX_OUTPUT

"
fi

COMMENT+="---
*This review was automatically generated by issue-ai-review hook.*"

# Post comment to issue
if gh issue comment "$ISSUE_NUMBER" --body "$COMMENT"; then
    echo "AI review posted to issue #$ISSUE_NUMBER"
else
    echo "Failed to post comment to issue #$ISSUE_NUMBER" >&2
    exit 1
fi
